include:
  - project: 'univention/documentation/sphinx-docker'
    file: 'pipeline/sphinx.yml'
  - project: univention/dist/docker-services
    file:
    - pre-commit.yml
    - kaniko.yml

workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && $CI_OPEN_MERGE_REQUESTS
    - if: $CI_PIPELINE_SOURCE == "push" && $CI_COMMIT_REF_PROTECTED == "true"
    - if: $CI_PIPELINE_SOURCE == "web"
    - if: $CI_PIPELINE_SOURCE == "webide"

stages:
  - lint
  - build
  - tests
  - merge
  - review
  - staging
  - production

variables:
  # Check the README for more information about the variables:
  # https://git.knut.univention.de/univention/documentation/sphinx-docker/-/blob/main/README.rst
  DOCS_DIR: "docs"
  DOC_TARGET_NAME: "ucsschool-id-connector"
  DOC_TARGET_PATH: "$DOC_TARGET_NAME"

.omar:
  variables:
    GIT_STRATEGY: none
  tags:
    - omar

run_pre_commit:
  stage: lint
  extends: .pre-commit
  variables:
    PRE_COMMIT_IMAGE: "docker-registry.knut.univention.de/knut/pre-commit-opa-python3.8"

build_docker_image:
  stage: build
  extends: .kaniko
  variables:
      KANIKO_BUILD_CONTEXT: "$CI_PROJECT_DIR/"
      KANIKO_ARGS: --build-arg app_id="$APP_ID" --build-arg commit="$CI_COMMIT_SHA" --build-arg date="$CI_JOB_STARTED_AT" --cache=true --cache-repo $CI_REGISTRY_IMAGE/cache --cache-copy-layers

tests:
  stage: tests
  needs:
    - job: build_docker_image
  image: $IMAGE_TAG
  script:
    - cd ${CI_PROJECT_DIR}/src && python3 -m pytest -l -v --color=yes tests/unittests

# docu pipelines

docs-linkcheck:
  extends: .sphinx-linkcheck-template
  rules:
    - changes:
      - $DOCS_DIR/**/*
      - "src/HISTORY.rst"

docs-spelling:
  extends: .sphinx-spelling-template
  rules:
    - changes:
      - $DOCS_DIR/**/*
      - "src/HISTORY.rst"

docs-html:
  extends: .sphinx-html-template
  rules:
    - changes:
      - $DOCS_DIR/**/*
      - "src/HISTORY.rst"

docs-pdf:
  extends: .sphinx-pdf-template
  rules:
    - changes:
      - $DOCS_DIR/**/*
      - "src/HISTORY.rst"

docs-warnings:
  extends: .sphinx-warnings-template
  rules:
    - changes:
      - $DOCS_DIR/**/*

docs-merge-to-one-artifact:
  extends: .sphinx-merge-template
  needs:
    - job: docs-html
    - job: docs-pdf
    - job: docs-spelling
      artifacts: false
    - job: docs-linkcheck
      artifacts: false
  rules:
    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
      changes:
      - $DOCS_DIR/**/*
      - "src/HISTORY.rst"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      changes:
      - $DOCS_DIR/**/*
      - "src/HISTORY.rst"
      when: manual

review:
  stage: review
  rules:
    - changes:
      - $DOCS_DIR/**/*
      - "src/HISTORY.rst"
      if: '$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
  extends: .omar
  needs:
    - job: docs-merge-to-one-artifact
      artifacts: true
  script:
    - rsync -av --delete "$CI_PROJECT_DIR"/out/"$DOC_TARGET_NAME" /var/univention/buildsystem2/test_mirror/ftp/download/docs-ucsschool-id-connector.$CI_BUILD_REF_SLUG
  environment:
    name: review/$CI_BUILD_REF_NAME
    url: http://apt.knut.univention.de/download/docs-ucs-school-id-connector.$CI_BUILD_REF_SLUG/
    on_stop: stop_review
    auto_stop_in: 1 week


stop_review:
  stage: staging
  rules:
    - changes:
      - $DOCS_DIR/**/*
      - "src/HISTORY.rst"
      if: '$CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH'
      when: manual
  needs:
    - review
  allow_failure: true
  extends: .omar
  script:
    - rm -rf /var/univention/buildsystem2/test_mirror/ftp/download/docs-ucsschool-id-connector.$CI_BUILD_REF_SLUG
  environment:
    name: review/$CI_BUILD_REF_NAME
    action: stop


pages:
  stage: staging
  rules:
      - changes:
        - $DOCS_DIR/**/*
        - "src/HISTORY.rst"
        if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  image: $GIT_SYNC
  needs:
    - job: docs-merge-to-one-artifact
  script:
    - mv "$CI_PROJECT_DIR"/out/"$DOC_TARGET_NAME" public
  environment:
    name: pages/$CI_BUILD_REF_NAME
    url: https://univention.gitpages.knut.univention.de/components/$DOC_TARGET_NAME/
  artifacts:
    paths:
      - public
    expire_in: 1 week


staging:
  stage: staging
  extends: .omar
  rules:
    - changes:
      - $DOCS_DIR/**/*
      - "src/HISTORY.rst"
      if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
  script:
      - rsync -av --delete "$CI_PROJECT_DIR"/out/ /var/univention/buildsystem2/test_mirror/ftp/download/docs/"$DOC_TARGET_NAME"/
  environment:
    name: staging
    url: http://apt.knut.univention.de/download/docs/$DOC_TARGET_NAME/


# The template has inherit:variables:false to prevent the passing of pipeline
# variables to downstream, and therefore $DOCS_DIR is not available here.
docs-create-production-merge-request:
  extends: .sphinx-docs-merge-request-template
  needs:
    - job: docs-merge-to-one-artifact
  rules:
    - if: '$CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH'
      changes:
      - docs/**/*
      - "src/HISTORY.rst"
